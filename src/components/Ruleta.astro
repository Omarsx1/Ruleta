---
// Ruleta component with Fortnite theme
---

<div class="flex justify-center items-center gap-16 min-h-screen px-8">
  <!-- Left Panel - Spin Control -->
  <div class="backdrop-blur-[25px] bg-white/5 p-8 rounded-3xl border border-white/20 shadow-[0_8px_32px_0_rgba(31,38,135,0.37)] w-[320px] self-center">
    <h3 class="text-white/90 font-semibold text-2xl mb-6 text-center tracking-wide">üéØ CONTROL DE GIROS</h3>
    
    <div class="space-y-6">
      <div>
        <label class="text-white/80 text-sm font-medium mb-3 block">Ganador en el giro:</label>
        <div class="grid grid-cols-5 gap-2">
          <button class="spin-selector bg-white/10 hover:bg-white/20 border border-white/30 rounded-lg py-2 px-3 text-white font-medium transition-all duration-300 hover:scale-105" data-spin="1">1</button>
          <button class="spin-selector bg-white/10 hover:bg-white/20 border border-white/30 rounded-lg py-2 px-3 text-white font-medium transition-all duration-300 hover:scale-105" data-spin="2">2</button>
          <button class="spin-selector bg-blue-500/30 hover:bg-blue-500/40 border border-blue-400/50 rounded-lg py-2 px-3 text-white font-medium transition-all duration-300 hover:scale-105 selected" data-spin="3">3</button>
          <button class="spin-selector bg-white/10 hover:bg-white/20 border border-white/30 rounded-lg py-2 px-3 text-white font-medium transition-all duration-300 hover:scale-105" data-spin="4">4</button>
          <button class="spin-selector bg-white/10 hover:bg-white/20 border border-white/30 rounded-lg py-2 px-3 text-white font-medium transition-all duration-300 hover:scale-105" data-spin="5">5</button>
        </div>
      </div>
      
      <div class="bg-white/5 rounded-xl p-4 border border-white/20">
        <div class="text-white/70 text-sm mb-2">Giro actual:</div>
        <div id="currentSpinCount" class="text-white font-bold text-2xl">0</div>
      </div>
      
      <div class="bg-white/5 rounded-xl p-4 border border-white/20">
        <div class="text-white/70 text-sm mb-2">Ganador se decidir√° en:</div>
        <div id="selectedSpinNumber" class="text-blue-400 font-bold text-2xl">Giro 3</div>
      </div>
    </div>
  </div>

  <!-- Wheel Container -->
  <div class="flex flex-col items-center gap-8 relative">
    <!-- Pointer pointing inward -->
    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-2 z-20">
      <div class="w-0 h-0 border-l-[35px] border-r-[35px] border-t-[55px] border-l-transparent border-r-transparent border-t-fortnite-yellow filter drop-shadow-[0_4px_8px_rgba(255,215,0,0.5)]"></div>
    </div>
    
    <!-- Wheel without Glass Effect (removed) -->
    <div id="wheel" class="relative w-[700px] h-[700px] rounded-full border border-white/20 overflow-hidden mb-10">
      <!-- Dynamic Segments -->
      <div id="segments"></div>
      
      <!-- Center Circle -->
      <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-28 h-28 bg-white/90 rounded-full border border-white/30 flex items-center justify-center z-10 backdrop-blur-[15px] shadow-[0_4px_16px_0_rgba(31,38,135,0.3)]">
        <img src="/F.svg" alt="F" class="w-12 h-12" style="filter: invert(60%) sepia(75%) saturate(1000%) hue-rotate(165deg) brightness(100%) contrast(95%);" />
      </div>
    </div>
    
    <!-- Spin Button -->
    <button 
      id="spinButton" 
      class="backdrop-blur-[25px] bg-white/10 hover:bg-white/20 px-10 py-5 rounded-2xl text-white font-semibold text-2xl border border-white/20 shadow-[0_8px_32px_0_rgba(31,38,135,0.37)] transform hover:scale-105 transition-all duration-300 active:scale-95"
    >
      üéÆ ¬°GIRAR RULETA! üéÆ
    </button>
    
    <!-- Result Popup Modal (hidden by default) -->
    <div id="resultModal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-all duration-500">
      <!-- Backdrop with blur -->
      <div class="absolute inset-0 bg-black/50 backdrop-blur-md"></div>
      
      <!-- Modal Content -->
      <div class="relative z-60 bg-gradient-to-br from-slate-800/90 to-slate-900/90 backdrop-blur-[25px] p-16 rounded-3xl border-2 border-white/30 shadow-[0_20px_60px_0_rgba(0,0,0,0.5)] transform scale-75 transition-transform duration-500 w-[600px] max-w-[90vw]">
        <div class="text-center">
          <div class="text-8xl mb-8">üéâ</div>
          <h2 class="text-white/90 text-4xl font-semibold mb-6">¬°GANADOR!</h2>
          <div id="resultText" class="text-fortnite-yellow font-black text-6xl mb-10 tracking-wide"></div>
          <button id="closeModal" class="backdrop-blur-[15px] bg-white/10 hover:bg-white/20 px-12 py-4 rounded-xl text-white font-medium text-xl border border-white/30 transition-all duration-300 hover:scale-105">
            ‚ú® ¬°Genial!
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Options Panel -->
  <div class="backdrop-blur-[25px] bg-white/5 p-10 rounded-3xl border border-white/20 shadow-[0_8px_32px_0_rgba(31,38,135,0.37)] w-[450px] self-center mt-[-200px]">
    <h3 class="text-white/90 font-semibold text-2xl mb-6 text-center tracking-wide">‚öôÔ∏è OPCIONES</h3>
    
    <!-- Options List -->
    <div id="optionsList" class="space-y-3 max-h-80 overflow-y-auto scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent">
      <!-- Dynamic options will be inserted here -->
    </div>
    
    <!-- Add Option -->
    <div class="space-y-4">
      <input 
        type="text" 
        id="newOption" 
        placeholder="Nueva opci√≥n..." 
        class="w-full px-4 py-3 backdrop-blur-[15px] bg-white/10 border border-white/30 rounded-xl text-white placeholder-white/60 focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all duration-300"
        maxlength="20"
      />
      <button 
        id="addOption" 
        class="w-full backdrop-blur-[15px] bg-green-500/20 hover:bg-green-500/30 px-4 py-3 rounded-xl text-white font-medium border border-white/30 transition-all duration-300 hover:scale-105"
      >
        ‚ûï Agregar
      </button>
      <button 
        id="resetOptions" 
        class="w-full backdrop-blur-[15px] bg-red-500/20 hover:bg-red-500/30 px-4 py-3 rounded-xl text-white font-medium border border-white/30 transition-all duration-300 hover:scale-105"
      >
        üîÑ Resetear
      </button>
    </div>
  </div>
</div>

<script>
  const wheel = document.getElementById('wheel') as HTMLElement;
  const spinButton = document.getElementById('spinButton') as HTMLButtonElement;
  const resultModal = document.getElementById('resultModal') as HTMLElement;
  const resultText = document.getElementById('resultText') as HTMLElement;
  const closeModal = document.getElementById('closeModal') as HTMLButtonElement;
  const segments = document.getElementById('segments') as HTMLElement;
  const optionsList = document.getElementById('optionsList') as HTMLElement;
  const newOptionInput = document.getElementById('newOption') as HTMLInputElement;
  const addOptionButton = document.getElementById('addOption') as HTMLButtonElement;
  const resetOptionsButton = document.getElementById('resetOptions') as HTMLButtonElement;
  
  let options = [
    'Opci√≥n 1', 'Opci√≥n 2', 'Opci√≥n 3', 'Opci√≥n 4',
    'Opci√≥n 5', 'Opci√≥n 6', 'Opci√≥n 7', 'Opci√≥n 8'
  ];
  
  const colors = [
    '#00D4FF', '#FF6B35', '#32CD32', '#8B5CF6',
    '#FFD700', '#FF1493', '#DC2626', '#6B7280'
  ];
  
  let isSpinning = false;
  let currentRotation = 0;
  let currentSpinCount = 0;
  let selectedWinningSpinNumber = 3;
  
  function createConfetti() {
    const confettiContainer = document.createElement('div');
    confettiContainer.style.position = 'fixed';
    confettiContainer.style.top = '0';
    confettiContainer.style.left = '0';
    confettiContainer.style.width = '100%';
    confettiContainer.style.height = '100%';
    confettiContainer.style.pointerEvents = 'none';
    confettiContainer.style.zIndex = '10000';
    document.body.appendChild(confettiContainer);
    
    const confettiColors = ['#FFD700', '#FF6B35', '#00D4FF', '#32CD32', '#8B5CF6', '#FF1493'];
    
    for (let i = 0; i < 100; i++) {
      const confetti = document.createElement('div');
      confetti.style.position = 'absolute';
      confetti.style.width = '10px';
      confetti.style.height = '10px';
      confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.top = '-10px';
      confetti.style.borderRadius = '50%';
      confetti.style.animation = `confettiFall ${2 + Math.random() * 3}s linear forwards`;
      confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
      confettiContainer.appendChild(confetti);
    }
    
    // Remove confetti after animation
    setTimeout(() => {
      document.body.removeChild(confettiContainer);
    }, 5000);
  }
  
  function createSegments() {
    if (!segments) return;
    segments.innerHTML = '';
    
    const segmentAngle = 360 / options.length;
    
    options.forEach((option, index) => {
      const segment = document.createElement('div');
      segment.className = 'absolute w-full h-full';
      segment.style.zIndex = '10';
      
      const startAngle = index * segmentAngle;
      const endAngle = (index + 1) * segmentAngle;
      const midAngle = (startAngle + endAngle) / 2;
      
      // Crear clip-path con bordes circulares redondeados
      const segmentRadius = 48.5; // Menor que 50 para crear espacio visible entre segmentos
      
      // Calculamos puntos para crear un arco en lugar de l√≠neas rectas
      const startX = 50 + segmentRadius * Math.cos((startAngle - 90) * Math.PI / 180);
      const startY = 50 + segmentRadius * Math.sin((startAngle - 90) * Math.PI / 180);
      const endX = 50 + segmentRadius * Math.cos((endAngle - 90) * Math.PI / 180);
      const endY = 50 + segmentRadius * Math.sin((endAngle - 90) * Math.PI / 180);
      
      // Crear un clip-path con muchos m√°s puntos para una curva perfectamente suave
      const numPoints = 20; // Muchos m√°s puntos para una curva ultra suave
      let clipPathPoints = `50% 50%, `; // Punto central
      
      // Generar puntos a lo largo del arco para crear una curva perfecta
      for (let i = 0; i <= numPoints; i++) {
        const angle = startAngle + (i * (endAngle - startAngle) / numPoints);
        const x = 50 + segmentRadius * Math.cos((angle - 90) * Math.PI / 180);
        const y = 50 + segmentRadius * Math.sin((angle - 90) * Math.PI / 180);
        clipPathPoints += `${x}% ${y}%`;
        if (i < numPoints) clipPathPoints += ', ';
      }
      
      segment.style.clipPath = `polygon(${clipPathPoints})`;
      
      // Contenido del segmento con color
      const segmentContent = document.createElement('div');
      segmentContent.className = 'w-full h-full relative';
      
      const baseColor = colors[index % colors.length];
      const r = parseInt(baseColor.slice(1, 3), 16);
      const g = parseInt(baseColor.slice(3, 5), 16);
      const b = parseInt(baseColor.slice(5, 7), 16);
      const rgbaColor = `rgba(${r}, ${g}, ${b}, 0.8)`;
      
      segmentContent.style.backgroundColor = rgbaColor;
      segmentContent.style.border = '1px solid rgba(255, 255, 255, 0.2)';
      
      // Texto del segmento - posicionamiento radial siguiendo la curvatura
      const textElement = document.createElement('div');
      textElement.style.position = 'absolute';
      textElement.style.top = '50%';
      textElement.style.left = '50%';
      textElement.style.transformOrigin = '0 0';
      textElement.style.zIndex = '50';
      textElement.style.pointerEvents = 'none';
      
      // Calcular la posici√≥n para que el texto est√© centrado en el segmento
      const textRadius = 220; // Distancia del centro para mejor centrado
      const textAngle = midAngle - 90; // Ajustar para que 0¬∞ sea arriba
      const textX = textRadius * Math.cos(textAngle * Math.PI / 180);
      const textY = textRadius * Math.sin(textAngle * Math.PI / 180);
      
      // Rotar el texto para que siga la tangente del arco pero siempre inicie desde el centro
      const textRotation = midAngle - 90; // -90 para que inicie desde el centro hacia afuera
      
      textElement.style.transform = `translate(${textX}px, ${textY}px) rotate(${textRotation}deg)`;
      
      const textSpan = document.createElement('span');
      textSpan.textContent = option;
      textSpan.style.color = '#FFFFFF';
      textSpan.style.fontSize = '24px'; // Texto m√°s grande
      textSpan.style.fontWeight = 'bold';
      textSpan.style.textAlign = 'center';
      textSpan.style.textShadow = '3px 3px 8px rgba(0,0,0,0.9), 0 0 12px rgba(0,0,0,0.8), 2px 2px 0px rgba(0,0,0,1)';
      textSpan.style.whiteSpace = 'nowrap';
      textSpan.style.display = 'inline-block';
      textSpan.style.letterSpacing = '1.5px';
      textSpan.style.transform = 'translateX(-50%) translateY(-50%)'; // Centrar horizontal y verticalmente
      
      textElement.appendChild(textSpan);
      segmentContent.appendChild(textElement);
      segment.appendChild(segmentContent);
      segments.appendChild(segment);
    });
  }
  
  function updateOptionsList() {
    if (!optionsList) return;
    optionsList.innerHTML = '';
    
    options.forEach((option, index) => {
      const optionItem = document.createElement('div');
      optionItem.className = 'flex items-center justify-between p-3 backdrop-blur-[15px] bg-white/10 rounded-xl border border-white/20 hover:bg-white/15 transition-all duration-300 group';
      
      const optionInput = document.createElement('input');
      optionInput.type = 'text';
      optionInput.value = option;
      optionInput.className = 'bg-transparent text-white/90 font-medium outline-none border-none flex-1 mr-3 focus:text-white';
      optionInput.maxLength = 20;
      
      // Update option in real-time while typing
      optionInput.addEventListener('input', () => {
        const newValue = optionInput.value.trim();
        if (newValue) {
          options[index] = newValue;
          createSegments();
        }
      });
      
      // Handle blur to restore original if empty
      optionInput.addEventListener('blur', () => {
        const newValue = optionInput.value.trim();
        if (!newValue) {
          optionInput.value = option; // Restore original if empty
          options[index] = option;
          createSegments();
        }
      });
      
      // Handle Enter key
      optionInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          optionInput.blur();
        }
      });
      
      const removeButton = document.createElement('button');
      removeButton.className = 'text-red-400 hover:text-red-300 font-bold text-xl transition-colors duration-200 opacity-70 group-hover:opacity-100';
      removeButton.innerHTML = '√ó';
      removeButton.onclick = () => removeOption(index);
      
      optionItem.appendChild(optionInput);
      optionItem.appendChild(removeButton);
      optionsList.appendChild(optionItem);
    });
  }
  
  function addOption() {
    if (!newOptionInput) return;
    const newOption = newOptionInput.value.trim();
    if (newOption && options.length < 12) {
      options.push(newOption);
      newOptionInput.value = '';
      createSegments();
      updateOptionsList();
    }
  }
  
  function removeOption(index: number) {
    if (options.length > 2) {
      options.splice(index, 1);
      createSegments();
      updateOptionsList();
    }
  }
  
  function resetOptions() {
    options = [
      'Opci√≥n 1', 'Opci√≥n 2', 'Opci√≥n 3', 'Opci√≥n 4',
      'Opci√≥n 5', 'Opci√≥n 6', 'Opci√≥n 7', 'Opci√≥n 8'
    ];
    createSegments();
    updateOptionsList();
  }
  
  // Event listeners
  spinButton?.addEventListener('click', () => {
    if (isSpinning || options.length < 2) return;
    
    isSpinning = true;
    spinButton.disabled = true;
    spinButton.textContent = 'üîÑ GIRANDO...';
    
    const minRotation = 1080;
    const maxRotation = 2160;
    const additionalRotation = Math.random() * (maxRotation - minRotation) + minRotation;
    const newRotation = currentRotation + additionalRotation;
    
    if (wheel) {
      wheel.style.transition = 'none';
      wheel.style.transform = `rotate(${currentRotation}deg)`;
      
      // Force reflow
      wheel.offsetHeight;
      
      wheel.style.transition = 'transform 3s cubic-bezier(0.23, 1, 0.320, 1)';
      wheel.style.transform = `rotate(${newRotation}deg)`;
    }
    
    currentRotation = newRotation;
    const normalizedRotation = newRotation % 360;
    const segmentAngle = 360 / options.length;
    // La ruleta gira en sentido horario, pero necesitamos invertir para obtener el √≠ndice correcto
    // La flecha est√° fija en la parte superior, calculamos qu√© segmento pasa por debajo
    const invertedRotation = (360 - normalizedRotation) % 360;
    const selectedIndex = Math.floor(invertedRotation / segmentAngle) % options.length;
    
    // Increment spin count
    currentSpinCount++;
    const currentSpinCountEl = document.getElementById('currentSpinCount');
    if (currentSpinCountEl) {
      currentSpinCountEl.textContent = currentSpinCount.toString();
    }
    
    setTimeout(() => {
      const selectedOption = options[selectedIndex];
      
      // Check if this is the winning spin
      const isWinningSpin = currentSpinCount === selectedWinningSpinNumber;
      
      if (isWinningSpin) {
        // Show modal with result only on winning spin
        if (resultText) {
          resultText.textContent = selectedOption;
        }
        
        if (resultModal) {
        resultModal.style.opacity = '1';
        resultModal.style.pointerEvents = 'auto';
        const modalContent = resultModal.querySelector('div > div') as HTMLElement;
        if (modalContent) {
          modalContent.style.transform = 'scale(1)';
        }
      }
      
        // Trigger confetti animation only on winning spin
        createConfetti();
        
        // Reset spin count after showing winner to start new round
        currentSpinCount = 0;
        const currentSpinCountEl = document.getElementById('currentSpinCount');
        if (currentSpinCountEl) {
          currentSpinCountEl.textContent = '0';
        }
      }
      
      isSpinning = false;
      spinButton.disabled = false;
      spinButton.textContent = 'üéÆ ¬°GIRAR RULETA! üéÆ';
    }, 3000);
  });
  
  // Spin selector buttons functionality
  const spinSelectors = document.querySelectorAll('.spin-selector') as NodeListOf<HTMLButtonElement>;
  const selectedSpinNumberEl = document.getElementById('selectedSpinNumber') as HTMLElement;
  
  spinSelectors.forEach(button => {
    button.addEventListener('click', () => {
      // Remove selected class from all buttons
      spinSelectors.forEach(btn => {
        btn.classList.remove('selected', 'bg-blue-500/30', 'border-blue-400/50');
        btn.classList.add('bg-white/10', 'border-white/30');
      });
      
      // Add selected class to clicked button
      button.classList.add('selected', 'bg-blue-500/30', 'border-blue-400/50');
      button.classList.remove('bg-white/10', 'border-white/30');
      
      // Update selected winning spin number
      selectedWinningSpinNumber = parseInt(button.dataset.spin || '3');
      if (selectedSpinNumberEl) {
        selectedSpinNumberEl.textContent = `Giro ${selectedWinningSpinNumber}`;
      }
      
      // Reset spin count when changing the winning spin number
      currentSpinCount = 0;
      const currentSpinCountEl = document.getElementById('currentSpinCount');
      if (currentSpinCountEl) {
        currentSpinCountEl.textContent = '0';
      }
    });
  });

  addOptionButton?.addEventListener('click', addOption);
  resetOptionsButton?.addEventListener('click', resetOptions);
  
  newOptionInput?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      addOption();
    }
  });
  
  // Close modal event listener
  closeModal?.addEventListener('click', () => {
    if (resultModal) {
      resultModal.style.opacity = '0';
      resultModal.style.pointerEvents = 'none';
      const modalContent = resultModal.querySelector('div > div') as HTMLElement;
      if (modalContent) {
        modalContent.style.transform = 'scale(0.75)';
      }
    }
  });
  
  // Initialize
  createSegments();
  updateOptionsList();
</script>

<style>
  #wheel {
    transition: transform 3s cubic-bezier(0.23, 1, 0.320, 1);
  }
  
  button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none !important;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  #result {
    animation: pulse 2s infinite;
  }
  
  @keyframes confettiFall {
    0% {
      transform: translateY(-10px) rotate(0deg);
      opacity: 1;
    }
    100% {
      transform: translateY(100vh) rotate(720deg);
      opacity: 0;
    }
  }
</style>
